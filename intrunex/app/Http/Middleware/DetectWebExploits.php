<?php

namespace App\Http\Middleware;

use Closure;
use Illuminate\Http\Request;
use Illuminate\Support\Facades\Log;

class DetectWebExploits
{
    public function handle(Request $request, Closure $next)
    {
        $patterns = [
            '/(\%27)|(\')|(\-\-)|(\%23)|(#)/i',             // SQL Injection
            '/((\%3C)|<)[^\n]+((\%3E)|>)/i',                 // XSS
            '/((\.\.\/)+)/i',                                // Path Traversal
        ];

        $input = json_encode($request->all());

        foreach ($patterns as $pattern) {
            if (preg_match($pattern, $input)) {
                Log::warning('⚠️ Exploit attempt detected.', [
                    'ip' => $request->ip(),
                    'url' => $request->fullUrl(),
                    'payload' => $input
                ]);
                abort(403, 'Exploit attempt detected.');
            }
        }

        return $next($request);
    }
}
